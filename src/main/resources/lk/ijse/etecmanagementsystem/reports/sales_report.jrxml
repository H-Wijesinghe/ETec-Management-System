<!-- Created with Jaspersoft Studio version 7.0.3.final using JasperReports Library version 7.0.3-41034ca841d452f3305ba55b9042260aaa1ab5dd  -->
<jasperReport name="sales_report" language="java" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="fcee9e49-54c5-4cce-8221-8a6e25b37490">
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="MYSQL"/>
	<parameter name="fromDate" class="java.util.Date"/>
	<parameter name="toDate" class="java.util.Date"/>
	<query language="SQL"><![CDATA[SELECT 
    p.stock_id AS product_id,
    p.name AS product_name,
    combined.total_qty AS sold_product_qty,
    (combined.sales_revenue + (combined.repair_qty * p.sell_price)) AS total_revenue
FROM Product p
JOIN (
    SELECT 
        stock_id,
        SUM(qty) AS total_qty,
        SUM(sales_val) AS sales_revenue,
        SUM(repair_count) AS repair_qty
    FROM (
        SELECT 
            pi.stock_id, 
            si.qty, 
            si.total AS sales_val, 
            0 AS repair_count
        FROM Sales s
        INNER JOIN SalesItem si ON s.sale_id = si.sale_id
        INNER JOIN ProductItem pi ON si.item_id = pi.item_id
        WHERE s.sale_date BETWEEN $P{fromDate} AND $P{toDate}
          AND s.payment_status = 'PAID'

        UNION ALL

        SELECT 
            pi.stock_id, 
            1 AS qty, 
            0 AS sales_val, 
            1 AS repair_count
        FROM RepairJob rj
        INNER JOIN RepairItem ri ON rj.repair_id = ri.repair_id
        INNER JOIN ProductItem pi ON ri.item_id = pi.item_id
        WHERE rj.date_out BETWEEN $P{fromDate} AND $P{toDate}
          AND rj.payment_status = 'PAID'
    ) AS raw_stream
    GROUP BY stock_id
) AS combined ON p.stock_id = combined.stock_id]]></query>
	<field name="product_id" class="java.lang.Integer">
		<property name="com.jaspersoft.studio.field.name" value="stock_id"/>
		<property name="com.jaspersoft.studio.field.label" value="product_id"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="product"/>
	</field>
	<field name="product_name" class="java.lang.String">
		<property name="com.jaspersoft.studio.field.name" value="name"/>
		<property name="com.jaspersoft.studio.field.label" value="product_name"/>
		<property name="com.jaspersoft.studio.field.tree.path" value="product"/>
	</field>
	<field name="sold_product_qty" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="total_qty"/>
		<property name="com.jaspersoft.studio.field.label" value="sold_product_qty"/>
	</field>
	<field name="total_revenue" class="java.math.BigDecimal">
		<property name="com.jaspersoft.studio.field.name" value="total_revenue"/>
		<property name="com.jaspersoft.studio.field.label" value="total_revenue"/>
	</field>
	<variable name="grandTotal" calculation="Sum" class="java.math.BigDecimal">
		<expression><![CDATA[$F{total_revenue}]]></expression>
	</variable>
	<background splitType="Stretch"/>
	<title height="126" splitType="Stretch">
		<element kind="rectangle" uuid="2effce1d-8fbc-4cb0-83e2-cfd46ea6e7aa" x="290" y="51" width="263" height="60" backcolor="#F0F0F0">
			<pen lineColor="#CCCCCC"/>
		</element>
		<element kind="textField" uuid="d4c187d2-ed4d-4d85-858d-9b2f033e5636" x="353" y="84" width="200" height="20" vTextAlign="Middle">
			<expression><![CDATA[new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{fromDate}) + " to " + new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{toDate})]]></expression>
		</element>
		<element kind="textField" uuid="96b62bf7-8e60-4678-ac0f-8eec0ab1cf68" x="410" y="56" width="130" height="20" fontSize="12.0" evaluationTime="Report" pattern="Rs #,##0.00" bold="true" hTextAlign="Right" vTextAlign="Middle">
			<expression><![CDATA[$V{grandTotal} == null ? java.math.BigDecimal.ZERO : $V{grandTotal}]]></expression>
		</element>
		<element kind="staticText" uuid="1c5bc6c8-ca63-4d78-b505-0a03ab3dba85" x="290" y="56" width="99" height="20" bold="true" hTextAlign="Right" vTextAlign="Middle">
			<text><![CDATA[SALES TOTAL:]]></text>
		</element>
		<element kind="staticText" uuid="562b305b-f91b-407e-b3ce-1fdbe9f3d636" x="292" y="84" width="60" height="20" bold="true" hTextAlign="Right" vTextAlign="Middle">
			<text><![CDATA[Period:]]></text>
		</element>
		<element kind="image" uuid="915159c2-5168-4241-a0a3-663109f23f78" x="95" y="0" width="90" height="60" onErrorType="Blank" linkType="None" linkTarget="Self" hImageAlign="Center" vImageAlign="Middle">
			<expression><![CDATA["src/main/resources/lk/ijse/etecmanagementsystem/images/ETBatch.png"]]></expression>
			<property name="com.jaspersoft.studio.unit.width" value="px"/>
			<property name="com.jaspersoft.studio.unit.height" value="px"/>
		</element>
		<element kind="staticText" uuid="eec57cc9-bd77-4adb-b682-352d0569792f" x="0" y="92" width="280" height="12" forecolor="#000000" fontSize="8.0" bold="true" hTextAlign="Center">
			<text><![CDATA[Tel: +94 00 000 0000]]></text>
			<property name="com.jaspersoft.studio.unit.height" value="px"/>
		</element>
		<element kind="staticText" uuid="d97fdbbc-a6f3-4f36-a9d9-c1f0e796a1e6" x="0" y="51" width="280" height="30" forecolor="#000000" fontName="SansSerif" fontSize="20.0" bold="true" hTextAlign="Center" vTextAlign="Middle">
			<text><![CDATA[ETec Computers]]></text>
		</element>
		<element kind="staticText" uuid="109e011a-1cd6-45d6-b026-e8e8a9af1371" x="0" y="80" width="280" height="12" forecolor="#000000" fontSize="8.0" hTextAlign="Center">
			<text><![CDATA[Nagoda, Galle, Sri Lanka]]></text>
			<property name="com.jaspersoft.studio.unit.height" value="px"/>
		</element>
	</title>
	<pageHeader height="35" splitType="Stretch">
		<element kind="staticText" uuid="ebb28a90-0c0e-465d-b8a7-2a1777019287" x="0" y="2" width="270" height="30" fontSize="16.0" bold="false" hTextAlign="Left" vTextAlign="Top">
			<text><![CDATA[Detailed Sales Report]]></text>
		</element>
	</pageHeader>
	<columnHeader height="30" splitType="Stretch">
		<element kind="rectangle" uuid="fca67e90-6f1a-421f-b3a4-c60c4eff1b2a" x="0" y="0" width="555" height="30" backcolor="#E0E0E0">
			<pen lineWidth="0.0"/>
		</element>
		<element kind="staticText" uuid="4ba48092-d703-4eee-a639-0dc298267509" x="380" y="0" width="59" height="30" bold="true" hTextAlign="Center" vTextAlign="Middle">
			<text><![CDATA[Qty]]></text>
		</element>
		<element kind="staticText" uuid="93697975-c9f7-4acd-91fa-0bf68604df12" x="0" y="0" width="80" height="30" fontSize="10.0" bold="true" vTextAlign="Middle">
			<text><![CDATA[  Product ID]]></text>
		</element>
		<element kind="staticText" uuid="830b8593-2a01-4c03-a9f4-c0f0508c6848" x="80" y="0" width="300" height="30" fontSize="10.0" bold="true" vTextAlign="Middle">
			<text><![CDATA[  Product Name]]></text>
		</element>
		<element kind="staticText" uuid="a92f7ba7-70cb-41cd-bd17-fff14003356a" x="439" y="0" width="114" height="30" bold="true" hTextAlign="Center" vTextAlign="Middle">
			<text><![CDATA[  Total(Rs)]]></text>
		</element>
	</columnHeader>
	<detail>
		<band height="27" splitType="Stretch">
			<element kind="textField" uuid="2f0658fa-6aa6-4b3b-9ea8-88af14526e68" x="85" y="0" width="294" height="25" vTextAlign="Middle">
				<expression><![CDATA[$F{product_name}]]></expression>
			</element>
			<element kind="textField" uuid="557c77d3-b14c-463c-aa29-8183408a14ea" x="380" y="0" width="59" height="25" hTextAlign="Center" vTextAlign="Middle">
				<expression><![CDATA[$F{sold_product_qty}]]></expression>
			</element>
			<element kind="textField" uuid="a882e4ed-d144-476a-805e-af3081fb3773" x="6" y="0" width="74" height="25" vTextAlign="Middle">
				<expression><![CDATA[$F{product_id}]]></expression>
			</element>
			<element kind="textField" uuid="63de0f7a-b3f8-483e-8ff5-caa36570b611" x="439" y="0" width="114" height="25" pattern="#,##0.00" hTextAlign="Right" vTextAlign="Middle">
				<expression><![CDATA[$F{total_revenue}]]></expression>
			</element>
		</band>
	</detail>
	<columnFooter height="3" splitType="Stretch">
		<element kind="line" uuid="5c4cd463-a193-4b4f-adbb-0110e9beb483" x="0" y="0" width="555" height="1" forecolor="#CCCCCC"/>
	</columnFooter>
	<pageFooter height="33" splitType="Stretch">
		<element kind="textField" uuid="7c62dc76-be1a-4e9c-a36f-e2fd17cde4e5" x="0" y="0" width="100" height="30" pattern="MMMMM dd, yyyy" vTextAlign="Middle">
			<expression><![CDATA[new java.util.Date()]]></expression>
		</element>
		<element kind="textField" uuid="f58b4369-8539-4bef-9bb6-a8a852a71b17" x="353" y="1" width="200" height="30" hTextAlign="Center" vTextAlign="Middle">
			<expression><![CDATA["Page " + $V{PAGE_NUMBER}]]></expression>
		</element>
	</pageFooter>
	<summary splitType="Stretch"/>
</jasperReport>
